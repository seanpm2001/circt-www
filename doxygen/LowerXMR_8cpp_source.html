<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CIRCT: /home/runner/work/circt-www/circt-www/circt_src/lib/Dialect/FIRRTL/Transforms/LowerXMR.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CIRCT
   &#160;<span id="projectnumber">17.0.0git</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_1a25ec519b6c1121408b67cc33ce3f15.html">Dialect</a></li><li class="navelem"><a class="el" href="dir_5ecba3b4683443cdd5d71918532517b3.html">FIRRTL</a></li><li class="navelem"><a class="el" href="dir_1f43711e4003e7a9e3d354ad53319866.html">Transforms</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">LowerXMR.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="LowerXMR_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">//===- LowerXMR.cpp - FIRRTL Lower to XMR -----------------------*- C++ -*-===//</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// See https://llvm.org/LICENSE.txt for license information.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">//===----------------------------------------------------------------------===//</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// This file implements FIRRTL XMR Lowering.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">//===----------------------------------------------------------------------===//</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160; </div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="SystemC_2Transforms_2PassDetails_8h.html">PassDetails.h</a>&quot;</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="FIRRTLInstanceGraph_8h.html">circt/Dialect/FIRRTL/FIRRTLInstanceGraph.h</a>&quot;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="FIRRTLUtils_8h.html">circt/Dialect/FIRRTL/FIRRTLUtils.h</a>&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="Dialect_2FIRRTL_2Passes_8h.html">circt/Dialect/FIRRTL/Passes.h</a>&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="SVOps_8h.html">circt/Dialect/SV/SVOps.h</a>&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;mlir/IR/BuiltinOps.h&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;mlir/IR/ImplicitLocOpBuilder.h&quot;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;llvm/ADT/BitVector.h&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;llvm/ADT/DenseMap.h&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;llvm/ADT/EquivalenceClasses.h&quot;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;llvm/ADT/PostOrderIterator.h&quot;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;llvm/Support/Debug.h&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160; </div>
<div class="line"><a name="l00026"></a><span class="lineno"><a class="line" href="LowerXMR_8cpp.html#ad78e062f62e0d6e453941fb4ca843e4d">   26</a></span>&#160;<span class="preprocessor">#define DEBUG_TYPE &quot;firrtl-lower-xmr&quot;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160; </div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespacecirct.html">circt</a>;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">using namespace </span>firrtl;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">using</span> hw::InnerRefAttr;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">/// The LowerXMRPass will replace every RefResolveOp with an XMR encoded within</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">/// a verbatim expr op. This also removes every RefType port from the modules</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">/// and corresponding instances. This is a dataflow analysis over a very</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">/// constrained RefType. Domain of the dataflow analysis is the set of all</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">/// RefSendOps. It computes an interprocedural reaching definitions (of</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">/// RefSendOp) analysis. Essentially every RefType value must be mapped to one</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">/// and only one RefSendOp. The analysis propagates the dataflow from every</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">/// RefSendOp to every value of RefType across modules. The RefResolveOp is the</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">/// final leaf into which the dataflow must reach.</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">///</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">/// Since there can be multiple readers, multiple RefResolveOps can be reachable</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">/// from a single RefSendOp. To support multiply instantiated modules and</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">/// multiple readers, it is essential to track the path to the RefSendOp, other</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">/// than just the RefSendOp. For example, if there exists a wire `xmr_wire` in</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">/// module `Foo`, the algorithm needs to support generating Top.Bar.Foo.xmr_wire</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">/// and Top.Foo.xmr_wire and Top.Zoo.Foo.xmr_wire for different instance paths</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">/// that exist in the circuit.</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00050"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html">   50</a></span>&#160;<span class="keyword">class </span><a class="code" href="classLowerXMRPass.html">LowerXMRPass</a> : <span class="keyword">public</span> <a class="code" href="classLowerXMRBase.html">LowerXMRBase</a>&lt;LowerXMRPass&gt; {</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160; </div>
<div class="line"><a name="l00052"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a92a25b8006dfb4da40983f6c1972e634">   52</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classLowerXMRPass.html#a92a25b8006dfb4da40983f6c1972e634">runOnOperation</a>()<span class="keyword"> override </span>{</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160; </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="comment">// Populate a CircuitNamespace that can be used to generate unique</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="comment">// circuit-level symbols.</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <a class="code" href="structcirct_1_1firrtl_1_1CircuitNamespace.html">CircuitNamespace</a> ns(getOperation());</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    circuitNamespace = &amp;ns;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160; </div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    llvm::EquivalenceClasses&lt;Value, ValueComparator&gt; eq;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    dataFlowClasses = &amp;eq;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <a class="code" href="classcirct_1_1firrtl_1_1InstanceGraph.html">InstanceGraph</a> &amp;instanceGraph = getAnalysis&lt;InstanceGraph&gt;();</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    SmallVector&lt;RefResolveOp&gt; resolveOps;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    SmallVector&lt;Operation *&gt; forceAndReleaseOps;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="comment">// The dataflow function, that propagates the reachable RefSendOp across</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="comment">// RefType Ops.</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="keyword">auto</span> transferFunc = [&amp;](Operation &amp;op) -&gt; LogicalResult {</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;      <span class="keywordflow">return</span> TypeSwitch&lt;Operation *, LogicalResult&gt;(&amp;op)</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;          .Case&lt;RefSendOp&gt;([&amp;](RefSendOp send) {</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;            <span class="comment">// Get a reference to the actual signal to which the XMR will be</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;            <span class="comment">// generated.</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;            Value xmrDef = send.getBase();</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;            <span class="keywordflow">if</span> (isZeroWidth(send.getType().getType())) {</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;              markForRemoval(send);</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;              <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;            }</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;            <span class="comment">// Get an InnerRefAttr to the xmrDef op. If the operation does not</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;            <span class="comment">// take any InnerSym (like firrtl.add, firrtl.or etc) then create a</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;            <span class="comment">// NodeOp to add the InnerSym.</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;            <span class="keywordflow">if</span> (!xmrDef.isa&lt;BlockArgument&gt;()) {</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;              Operation *xmrDefOp = xmrDef.getDefiningOp();</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;              <span class="keywordflow">if</span> (<span class="keyword">auto</span> verbExpr = dyn_cast&lt;VerbatimExprOp&gt;(xmrDefOp))</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;                <span class="keywordflow">if</span> (verbExpr.getSymbolsAttr().empty() &amp;&amp;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                    xmrDefOp-&gt;hasOneUse()) {</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                  <span class="comment">// This represents the internal path into a module. For</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                  <span class="comment">// generating the correct XMR, no node can be created in this</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                  <span class="comment">// module. Create a null InnerRef and ensure the hierarchical</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                  <span class="comment">// path ends at the parent that instantiates this module.</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                  <span class="keyword">auto</span> inRef = InnerRefAttr();</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                  <span class="keyword">auto</span> ind = addReachingSendsEntry(send.getResult(), inRef);</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;                  xmrPathSuffix[ind] = verbExpr.getText();</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                  markForRemoval(verbExpr);</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                  markForRemoval(send);</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                  <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                }</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;              <span class="keywordflow">if</span> (!isa&lt;hw::InnerSymbolOpInterface&gt;(xmrDefOp) ||</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                  <span class="comment">/* No innner symbols for results of instances */</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;                  isa&lt;InstanceOp&gt;(xmrDefOp) ||</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;                  <span class="comment">/* Similarly, anything with multiple results isn&#39;t named by</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment">                     the inner sym */</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                  xmrDefOp-&gt;getResults().size() &gt; 1) {</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                <span class="comment">// Add a node, for non-innerSym ops. Otherwise the sym will be</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;                <span class="comment">// dropped after LowerToHW.</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                <span class="comment">// If the op has multiple results, we cannot add symbol to a</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                <span class="comment">// single result, so create a node from the result and add</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                <span class="comment">// symbol to the node.</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                ImplicitLocOpBuilder b(xmrDefOp-&gt;getLoc(), xmrDefOp);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                b.setInsertionPointAfter(xmrDefOp);</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                StringRef opName;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                <span class="keyword">auto</span> nameKind = NameKindEnum::DroppableName;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                <span class="keywordflow">if</span> (<span class="keyword">auto</span> name = xmrDefOp-&gt;getAttrOfType&lt;StringAttr&gt;(<span class="stringliteral">&quot;name&quot;</span>)) {</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                  opName = name.getValue();</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                  nameKind = NameKindEnum::InterestingName;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;                }</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                xmrDef = b.create&lt;NodeOp&gt;(xmrDef, opName, nameKind).getResult();</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;              }</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            }</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            <span class="comment">// Create a new entry for this RefSendOp. The path is currently</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            <span class="comment">// local.</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            addReachingSendsEntry(send.getResult(), <a class="code" href="namespacecirct_1_1firrtl.html#a5eefad9da2ff3aecab7b11cf35ac59d4">getInnerRefTo</a>(xmrDef));</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            markForRemoval(send);</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;            <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;          })</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;          .Case&lt;MemOp&gt;([&amp;](MemOp mem) {</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;            <span class="comment">// MemOp can produce debug ports of RefType. Each debug port</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;            <span class="comment">// represents the RefType for the corresponding register of the</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;            <span class="comment">// memory. Since the memory is not yet generated the register name</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            <span class="comment">// is assumed to be &quot;Memory&quot;. Note that MemOp creates RefType</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;            <span class="comment">// without a RefSend.</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;res : llvm::enumerate(mem.getResults()))</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;              <span class="keywordflow">if</span> (mem.getResult(res.index()).getType().isa&lt;RefType&gt;()) {</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                <span class="keyword">auto</span> inRef = <a class="code" href="namespacecirct_1_1firrtl.html#a5eefad9da2ff3aecab7b11cf35ac59d4">getInnerRefTo</a>(mem);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                <span class="keyword">auto</span> ind = addReachingSendsEntry(res.value(), inRef);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                xmrPathSuffix[ind] = <span class="stringliteral">&quot;Memory&quot;</span>;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                <span class="comment">// Just node that all the debug ports of memory must be removed.</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                <span class="comment">// So this does not record the port index.</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                refPortsToRemoveMap[mem].resize(1);</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;              }</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;            <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;          })</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;          .Case&lt;InstanceOp&gt;(</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;              [&amp;](<span class="keyword">auto</span> inst) { <span class="keywordflow">return</span> handleInstanceOp(inst, instanceGraph); })</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;          .Case&lt;FConnectLike&gt;([&amp;](FConnectLike <a class="code" href="namespacePython_1_1support.html#a0cb288c4cfff043062b7cd9001842aef">connect</a>) {</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;            <span class="comment">// Ignore BaseType.</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="namespacePython_1_1support.html#a0cb288c4cfff043062b7cd9001842aef">connect</a>.getSrc().getType().isa&lt;RefType&gt;())</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;              <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;            markForRemoval(<a class="code" href="namespacePython_1_1support.html#a0cb288c4cfff043062b7cd9001842aef">connect</a>);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;            <span class="keywordflow">if</span> (isZeroWidth(</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                    <a class="code" href="namespacePython_1_1support.html#a0cb288c4cfff043062b7cd9001842aef">connect</a>.getSrc().getType().cast&lt;RefType&gt;().getType()))</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;              <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;            <span class="comment">// Merge the dataflow classes of destination into the source of the</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;            <span class="comment">// Connect. This handles two cases:</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            <span class="comment">// 1. If the dataflow at the source is known, then the</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;            <span class="comment">// destination is also inferred. By merging the dataflow class of</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            <span class="comment">// destination with source, every value reachable from the</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            <span class="comment">// destination automatically infers a reaching RefSend.</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            <span class="comment">// 2. If dataflow at source is unkown, then just record that both</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            <span class="comment">// source and destination will have the same dataflow information.</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            <span class="comment">// Later in the pass when the reaching RefSend is inferred at the</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            <span class="comment">// leader of the dataflowClass, then we automatically infer the</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            <span class="comment">// dataflow at this connect and every value reachable from the</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            <span class="comment">// destination.</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            dataFlowClasses-&gt;unionSets(<a class="code" href="namespacePython_1_1support.html#a0cb288c4cfff043062b7cd9001842aef">connect</a>.getSrc(), <a class="code" href="namespacePython_1_1support.html#a0cb288c4cfff043062b7cd9001842aef">connect</a>.getDest());</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;            <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;          })</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;          .Case&lt;RefSubOp&gt;([&amp;](RefSubOp op) {</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;            markForRemoval(op);</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;            <span class="keywordflow">if</span> (isZeroWidth(op.getType().getType()))</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;              <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            <span class="keyword">auto</span> defMem =</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                dyn_cast_or_null&lt;MemOp&gt;(op.getInput().getDefiningOp());</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            <span class="keywordflow">if</span> (!defMem) {</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;              op.emitError(<span class="stringliteral">&quot;can only lower RefSubOp of Memory&quot;</span>)</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                      .attachNote(op.getInput().getLoc())</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                  &lt;&lt; <span class="stringliteral">&quot;input here&quot;</span>;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;              <span class="keywordflow">return</span> failure();</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;            }</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;            <span class="keyword">auto</span> inRef = <a class="code" href="namespacecirct_1_1firrtl.html#a5eefad9da2ff3aecab7b11cf35ac59d4">getInnerRefTo</a>(defMem);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            <span class="keyword">auto</span> ind = addReachingSendsEntry(op.getResult(), inRef);</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;            xmrPathSuffix[ind] = (<span class="stringliteral">&quot;Memory[&quot;</span> + Twine(op.getIndex()) + <span class="stringliteral">&quot;]&quot;</span>).str();</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160; </div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;            <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;          })</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;          .Case&lt;RefResolveOp&gt;([&amp;](RefResolveOp resolve) {</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;            <span class="comment">// Merge dataflow, under the same conditions as above for Connect.</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;            <span class="comment">// 1. If dataflow at the resolve.getRef is known, propagate that to</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;            <span class="comment">// the result. This is true for downward scoped XMRs, that is,</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;            <span class="comment">// RefSendOp must be visited before the corresponding RefResolveOp</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            <span class="comment">// is visited.</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;            <span class="comment">// 2. Else, just record that both result and ref should have the</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;            <span class="comment">// same reaching RefSend. This condition is true for upward scoped</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;            <span class="comment">// XMRs. That is, RefResolveOp can be visited before the</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;            <span class="comment">// corresponding RefSendOp is recorded.</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160; </div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            markForRemoval(resolve);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            <span class="keywordflow">if</span> (!isZeroWidth(resolve.getType()))</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;              dataFlowClasses-&gt;unionSets(resolve.getRef(), resolve.getResult());</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;            resolveOps.push_back(resolve);</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;            <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;          })</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;          .Case&lt;Forceable&gt;([&amp;](Forceable op) {</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;            <span class="keywordflow">if</span> (!op.isForceable() || op.getDataRef().use_empty())</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;              <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;            addReachingSendsEntry(op.getDataRef(), <a class="code" href="namespacecirct_1_1firrtl.html#a5eefad9da2ff3aecab7b11cf35ac59d4">getInnerRefTo</a>(op));</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;            <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;          })</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;          .Case&lt;RefForceOp, RefForceInitialOp, RefReleaseOp,</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                RefReleaseInitialOp&gt;([&amp;](<span class="keyword">auto</span> op) {</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;            forceAndReleaseOps.push_back(op);</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;            <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;          })</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;          .Default([&amp;](<span class="keyword">auto</span>) { <span class="keywordflow">return</span> success(); });</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    };</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    SmallVector&lt;FModuleOp&gt; publicModules;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160; </div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="comment">// Traverse the modules in post order.</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code" href="classLowerXMRPass.html#ad6a1ce92074f2bdb9cc4a29c186f2dea">node</a> : llvm::post_order(&amp;instanceGraph)) {</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      <span class="keyword">auto</span> module = dyn_cast&lt;FModuleOp&gt;(*<a class="code" href="classLowerXMRPass.html#ad6a1ce92074f2bdb9cc4a29c186f2dea">node</a>-&gt;getModule());</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      <span class="keywordflow">if</span> (!module)</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;      LLVM_DEBUG(<a class="code" href="namespacelec.html#af6450bd100960fe39a58efd9733ddea4">llvm::dbgs</a>()</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                 &lt;&lt; <span class="stringliteral">&quot;Traversing module:&quot;</span> &lt;&lt; module.getModuleNameAttr() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160; </div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;      <span class="keywordflow">if</span> (module.isPublic())</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        publicModules.push_back(module);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160; </div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;      <span class="keywordflow">for</span> (Operation &amp;op : module.getBodyBlock()-&gt;getOperations())</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="keywordflow">if</span> (transferFunc(op).failed())</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;          <span class="keywordflow">return</span> signalPassFailure();</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160; </div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;      <span class="comment">// Record all the RefType ports to be removed later.</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;      <span class="keywordtype">size_t</span> numPorts = module.getNumPorts();</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> portNum = 0; portNum &lt; numPorts; ++portNum)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        <span class="keywordflow">if</span> (module.getPortType(portNum).isa&lt;RefType&gt;()) {</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;          setPortToRemove(module, portNum, numPorts);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        }</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    }</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160; </div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    LLVM_DEBUG({</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;      <span class="keywordflow">for</span> (<span class="keyword">auto</span> I = dataFlowClasses-&gt;begin(), E = dataFlowClasses-&gt;end();</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;           I != E; ++I) { <span class="comment">// Iterate over all of the equivalence sets.</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        if (!I-&gt;isLeader())</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;          continue; <span class="comment">// Ignore non-leader sets.</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="comment">// Print members in this set.</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        llvm::interleave(llvm::make_range(dataFlowClasses-&gt;member_begin(I),</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                                          dataFlowClasses-&gt;member_end()),</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                         llvm::dbgs(), <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        llvm::dbgs() &lt;&lt; <span class="stringliteral">&quot;\n dataflow at leader::&quot;</span> &lt;&lt; I-&gt;getData() &lt;&lt; <span class="stringliteral">&quot;\n =&gt;&quot;</span>;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        auto iter = dataflowAt.find(I-&gt;getData());</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        if (iter != dataflowAt.end()) {</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;          for (auto init = refSendPathList[iter-&gt;getSecond()]; init.second;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;               init = refSendPathList[*init.second])</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            llvm::dbgs() &lt;&lt; <span class="stringliteral">&quot;\n path ::&quot;</span> &lt;&lt; init.first &lt;&lt; <span class="stringliteral">&quot;::&quot;</span> &lt;&lt; init.second;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        }</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <a class="code" href="namespacelec.html#af6450bd100960fe39a58efd9733ddea4">llvm::dbgs</a>() &lt;&lt; <span class="stringliteral">&quot;\n Done\n&quot;</span>; <span class="comment">// Finish set.</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;      }</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    });</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> refResolve : resolveOps)</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;      <span class="keywordflow">if</span> (handleRefResolve(refResolve).failed())</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        <span class="keywordflow">return</span> signalPassFailure();</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> *op : forceAndReleaseOps)</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;      <span class="keywordflow">if</span> (failed(handleForceReleaseOp(op)))</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        <span class="keywordflow">return</span> signalPassFailure();</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> module : publicModules) {</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      <span class="keywordflow">if</span> (failed(handlePublicModuleRefPorts(module)))</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="keywordflow">return</span> signalPassFailure();</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    }</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    garbageCollect();</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160; </div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="comment">// Clean up</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    moduleNamespaces.clear();</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    visitedModules.clear();</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    dataflowAt.clear();</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    refSendPathList.clear();</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    dataFlowClasses = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    refPortsToRemoveMap.clear();</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    opsToRemove.clear();</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    xmrPathSuffix.clear();</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    circuitNamespace = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    pathCache.clear();</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    pathInsertPoint = {};</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;  }</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">  /// Generate the ABI ref_&lt;circuit&gt;_&lt;module&gt; prefix string into `prefix`.</span></div>
<div class="line"><a name="l00286"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a8f0f600fa050b35b5cda5e7c6f29f47a">  286</a></span>&#160;<span class="comment"></span>  <span class="keywordtype">void</span> <a class="code" href="classLowerXMRPass.html#a8f0f600fa050b35b5cda5e7c6f29f47a">getRefABIPrefix</a>(FModuleLike mod, SmallVectorImpl&lt;char&gt; &amp;prefix) {</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    (Twine(<span class="stringliteral">&quot;ref_&quot;</span>) +</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;     (isa&lt;FExtModuleOp&gt;(mod) ? mod.getModuleName() : getOperation().getName()) +</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;     <span class="stringliteral">&quot;_&quot;</span> + mod.getModuleName())</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        .<a class="code" href="HandshakeExecutableOps_8cpp.html#ae2fc2adce0f8f62ecaa80aea76c72cdb">toVector</a>(prefix);</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  }</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">  /// Get full macro name as StringAttr for the specified ref port.</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">  /// Uses existing &#39;prefix&#39;, optionally preprends the backtick character.</span></div>
<div class="line"><a name="l00295"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#ad3948d553efd6e879f7a117b64027452">  295</a></span>&#160;<span class="comment"></span>  StringAttr <a class="code" href="classLowerXMRPass.html#ad3948d553efd6e879f7a117b64027452">getRefABIMacroForPort</a>(FModuleLike mod, <span class="keywordtype">size_t</span> portIndex,</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                                   <span class="keyword">const</span> Twine &amp;prefix, <span class="keywordtype">bool</span> backTick = <span class="keyword">false</span>) {</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="namespacecirct_1_1calyx_1_1direction.html#aa581977b67c4a52e186e2d320010f50f">StringAttr::get</a>(&amp;getContext(), Twine(backTick ? <span class="stringliteral">&quot;`&quot;</span> : <span class="stringliteral">&quot;&quot;</span>) + prefix +</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                                              <span class="stringliteral">&quot;_&quot;</span> + mod.getPortName(portIndex));</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;  }</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160; </div>
<div class="line"><a name="l00301"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a3f1a72db88eafeb5a7adf34234f7a9c0">  301</a></span>&#160;  LogicalResult <a class="code" href="classLowerXMRPass.html#a3f1a72db88eafeb5a7adf34234f7a9c0">resolveReferencePath</a>(mlir::TypedValue&lt;RefType&gt; refVal,</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                                     ImplicitLocOpBuilder <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>,</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                                     mlir::FlatSymbolRefAttr &amp;ref,</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                                     SmallString&lt;128&gt; &amp;stringLeaf) {</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="keyword">auto</span> remoteOpPath = getRemoteRefSend(refVal);</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordflow">if</span> (!remoteOpPath)</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;      <span class="keywordflow">return</span> failure();</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    SmallVector&lt;Attribute&gt; refSendPath;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    SmallVector&lt;Attribute&gt; refSendSimplePath;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <span class="keywordtype">size_t</span> lastIndex;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="keywordflow">while</span> (remoteOpPath) {</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;      lastIndex = *remoteOpPath;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;      <span class="keyword">auto</span> entr = refSendPathList[*remoteOpPath];</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;      <span class="comment">// If the path is a singular verbatim expression, the attribute of the</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;      <span class="comment">// send path list entry will be null</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;      <span class="keywordflow">if</span> (entr.first)</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        refSendPath.push_back(entr.first);</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;      remoteOpPath = entr.second;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    }</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="keyword">auto</span> iter = xmrPathSuffix.find(lastIndex);</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160; </div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="comment">// If this xmr has a suffix string (internal path into a module, that is not</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="comment">// yet generated).</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="keywordflow">if</span> (iter != xmrPathSuffix.end()) {</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;      <span class="keywordflow">if</span> (!refSendPath.empty())</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        stringLeaf.append(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;      stringLeaf.append(iter-&gt;getSecond());</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    }</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160; </div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="keywordflow">if</span> (!refSendPath.empty())</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;      <span class="comment">// Compute the HierPathOp that stores the path.</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;      ref = <a class="code" href="namespacecirct_1_1calyx_1_1direction.html#aa581977b67c4a52e186e2d320010f50f">FlatSymbolRefAttr::get</a>(</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;          getOrCreatePath(<a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.getArrayAttr(refSendPath), <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>)</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;              .getSymNameAttr());</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160; </div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  }</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160; </div>
<div class="line"><a name="l00339"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a2ce876a5713aa5672f44e510aaac216d">  339</a></span>&#160;  LogicalResult <a class="code" href="classLowerXMRPass.html#a2ce876a5713aa5672f44e510aaac216d">resolveReference</a>(mlir::TypedValue&lt;RefType&gt; refVal,</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                                 Type desiredType, Location loc,</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                                 Operation *insertBefore, Value &amp;out) {</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="keyword">auto</span> remoteOpPath = getRemoteRefSend(refVal);</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordflow">if</span> (!remoteOpPath)</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      <span class="keywordflow">return</span> failure();</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160; </div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    ImplicitLocOpBuilder <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>(loc, insertBefore);</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    mlir::FlatSymbolRefAttr ref;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    SmallString&lt;128&gt; xmrString;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keywordflow">if</span> (failed(resolveReferencePath(refVal, <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>, ref, xmrString)))</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      <span class="keywordflow">return</span> failure();</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160; </div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="comment">// Create the XMR op and convert it to the referenced FIRRTL type.</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keyword">auto</span> referentType = refVal.getType().getType();</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    Value xmrResult;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keyword">auto</span> xmrType = <a class="code" href="namespacecirct_1_1calyx_1_1direction.html#aa581977b67c4a52e186e2d320010f50f">sv::InOutType::get</a>(<a class="code" href="namespacecirct_1_1firrtl.html#ac239807a86d466ca630d2c61d8ab76f4">lowerType</a>(referentType));</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    xmrResult = <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                    .create&lt;sv::XMRRefOp&gt;(</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                        xmrType, ref,</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                        xmrString.empty() ? StringAttr{}</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                                          : <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.getStringAttr(xmrString))</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                    .getResult();</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    out =</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.create&lt;mlir::UnrealizedConversionCastOp&gt;(desiredType, xmrResult)</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;            .getResult(0);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  }</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160; </div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  <span class="comment">// Replace the Force/Release&#39;s ref argument with a resolved XMRRef.</span></div>
<div class="line"><a name="l00369"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#aaf949e3bee6facb7d9546cae89ca8947">  369</a></span>&#160;  LogicalResult <a class="code" href="classLowerXMRPass.html#aaf949e3bee6facb7d9546cae89ca8947">handleForceReleaseOp</a>(Operation *op) {</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="keywordflow">return</span> TypeSwitch&lt;Operation *, LogicalResult&gt;(op)</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        .Case&lt;RefForceOp, RefForceInitialOp, RefReleaseOp, RefReleaseInitialOp&gt;(</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            [&amp;](<span class="keyword">auto</span> op) {</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;              Value ref;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;              <span class="keywordflow">if</span> (failed(resolveReference(op.getDest(), op.getDest().getType(),</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                                          op.getLoc(), op, ref)))</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                <span class="keywordflow">return</span> failure();</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;              op.getDestMutable().assign(ref);</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;              <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            })</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        .Default([](<span class="keyword">auto</span> *op) {</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;          <span class="keywordflow">return</span> op-&gt;emitError(<span class="stringliteral">&quot;unexpected operation kind&quot;</span>);</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        });</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  }</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160; </div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  <span class="comment">// Replace the RefResolveOp with verbatim op representing the XMR.</span></div>
<div class="line"><a name="l00386"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a9aa1a2b971c6c4d874412f79130b5537">  386</a></span>&#160;  LogicalResult <a class="code" href="classLowerXMRPass.html#a9aa1a2b971c6c4d874412f79130b5537">handleRefResolve</a>(RefResolveOp resolve) {</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keyword">auto</span> resWidth = <a class="code" href="namespacecirct_1_1firrtl.html#afb23ce325dff5394c22df2487dffd4f1">getBitWidth</a>(resolve.getType());</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordflow">if</span> (resWidth.has_value() &amp;&amp; *resWidth == 0) {</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;      <span class="comment">// Donot emit 0 width XMRs, replace it with constant 0.</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;      ImplicitLocOpBuilder <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>(resolve.getLoc(), resolve);</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;      <span class="keyword">auto</span> zeroUintType = <a class="code" href="namespacecirct_1_1calyx_1_1direction.html#aa581977b67c4a52e186e2d320010f50f">UIntType::get</a>(<a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.getContext(), 0);</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;      <span class="keyword">auto</span> zeroC = <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.createOrFold&lt;BitCastOp&gt;(</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;          resolve.getType(), <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.create&lt;ConstantOp&gt;(</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                                 zeroUintType, <a class="code" href="namespacecirct_1_1firrtl.html#afe91edad7a64c9ec34e055ca4ce54635">getIntZerosAttr</a>(zeroUintType)));</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;      resolve.getResult().replaceAllUsesWith(zeroC);</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;      <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    }</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    Value result;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="keywordflow">if</span> (failed(resolveReference(resolve.getRef(), resolve.getType(),</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                                resolve.getLoc(), resolve, result)))</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;      <span class="keywordflow">return</span> failure();</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    resolve.getResult().replaceAllUsesWith(result);</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  }</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160; </div>
<div class="line"><a name="l00406"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a46b26eec1b23beda7287018682f09cd6">  406</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classLowerXMRPass.html#a46b26eec1b23beda7287018682f09cd6">setPortToRemove</a>(Operation *op, <span class="keywordtype">size_t</span> index, <span class="keywordtype">size_t</span> numPorts) {</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="keywordflow">if</span> (refPortsToRemoveMap[op].<a class="code" href="Schema_8cpp.html#aaead200a3c5da00983c0940a507aac19">size</a>() &lt; numPorts)</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;      refPortsToRemoveMap[op].resize(numPorts);</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    refPortsToRemoveMap[op].set(index);</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;  }</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160; </div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  <span class="comment">// Propagate the reachable RefSendOp across modules.</span></div>
<div class="line"><a name="l00413"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#aa95bf4b65745e19ee9526b0579aa6255">  413</a></span>&#160;  LogicalResult <a class="code" href="classLowerXMRPass.html#aa95bf4b65745e19ee9526b0579aa6255">handleInstanceOp</a>(InstanceOp inst,</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                                 <a class="code" href="classcirct_1_1firrtl_1_1InstanceGraph.html">InstanceGraph</a> &amp;instanceGraph) {</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    Operation *mod = instanceGraph.<a class="code" href="classcirct_1_1hw_1_1InstanceGraphBase.html#a18f485f0d18e1b9ad410f9063128ed27">getReferencedModule</a>(inst);</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">auto</span> extRefMod = dyn_cast&lt;FExtModuleOp&gt;(mod)) {</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;      <span class="comment">// Extern modules can generate RefType ports, they have an attached</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;      <span class="comment">// attribute which specifies the internal path into the extern module.</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;      <span class="comment">// This string attribute will be used to generate the final xmr.</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;      <span class="keyword">auto</span> internalPaths = extRefMod.getInternalPaths();</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;      <span class="keywordtype">size_t</span> pathsIndex = 0;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;      <span class="keyword">auto</span> numPorts = inst.getNumResults();</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;      SmallString&lt;128&gt; circuitRefPrefix;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="comment">      /// Get the resolution string for this ref-type port.</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment"></span>      <span class="keyword">auto</span> getPath = [&amp;](<span class="keywordtype">size_t</span> portNo) {</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        <span class="comment">// If there&#39;s an internalPaths array, grab the next element.</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        <span class="keywordflow">if</span> (!internalPaths.empty())</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;          <span class="keywordflow">return</span> internalPaths[pathsIndex++].cast&lt;StringAttr&gt;();</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160; </div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        <span class="comment">// Otherwise, we&#39;re using the ref ABI.  Generate the prefix string</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        <span class="comment">// and return the macro for the specified port.</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        <span class="keywordflow">if</span> (circuitRefPrefix.empty())</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;          getRefABIPrefix(extRefMod, circuitRefPrefix);</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160; </div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        <span class="keywordflow">return</span> getRefABIMacroForPort(extRefMod, portNo, circuitRefPrefix, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;      };</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160; </div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;res : llvm::enumerate(inst.getResults())) {</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        <span class="keywordflow">if</span> (!isa&lt;RefType&gt;(inst.getResult(res.index()).getType()))</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;          <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160; </div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        <span class="keyword">auto</span> inRef = <a class="code" href="namespacecirct_1_1firrtl.html#a5eefad9da2ff3aecab7b11cf35ac59d4">getInnerRefTo</a>(inst);</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="keyword">auto</span> ind = addReachingSendsEntry(res.value(), inRef);</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160; </div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        xmrPathSuffix[ind] = getPath(res.index());</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        <span class="comment">// The instance result and module port must be marked for removal.</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        setPortToRemove(inst, res.index(), numPorts);</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        setPortToRemove(extRefMod, res.index(), numPorts);</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;      }</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;      <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    }</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="keyword">auto</span> refMod = dyn_cast&lt;FModuleOp&gt;(mod);</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    <span class="keywordtype">bool</span> multiplyInstantiated = !visitedModules.insert(refMod).second;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> portNum = 0, numPorts = inst.getNumResults();</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;         portNum &lt; numPorts; ++portNum) {</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;      <span class="keyword">auto</span> instanceResult = inst.getResult(portNum);</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;      <span class="keywordflow">if</span> (!instanceResult.getType().isa&lt;RefType&gt;())</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;      <span class="keywordflow">if</span> (!refMod)</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="keywordflow">return</span> inst.emitOpError(<span class="stringliteral">&quot;cannot lower ext modules with RefType ports&quot;</span>);</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;      <span class="comment">// Reference ports must be removed.</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;      setPortToRemove(inst, portNum, numPorts);</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;      <span class="comment">// Drop the dead-instance-ports.</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;      <span class="keywordflow">if</span> (instanceResult.use_empty() ||</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;          isZeroWidth(instanceResult.getType().cast&lt;RefType&gt;().getType()))</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;      <span class="keyword">auto</span> refModuleArg = refMod.getArgument(portNum);</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;      <span class="keywordflow">if</span> (inst.getPortDirection(portNum) == <a class="code" href="namespacecirct_1_1firrtl.html#a10bd365aff28fd9856f68f241520e738a7c147cda9e49590f6abe83d118b7353b">Direction::Out</a>) {</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        <span class="comment">// For output instance ports, the dataflow is into this module.</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        <span class="comment">// Get the remote RefSendOp, that flows through the module ports.</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        <span class="comment">// If dataflow at remote module argument does not exist, error out.</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        <span class="keyword">auto</span> remoteOpPath = getRemoteRefSend(refModuleArg);</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <span class="keywordflow">if</span> (!remoteOpPath)</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;          <span class="keywordflow">return</span> failure();</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        <span class="comment">// Get the path to reaching refSend at the referenced module argument.</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="comment">// Now append this instance to the path to the reaching refSend.</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        addReachingSendsEntry(instanceResult, <a class="code" href="namespacecirct_1_1firrtl.html#a5eefad9da2ff3aecab7b11cf35ac59d4">getInnerRefTo</a>(inst),</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                              remoteOpPath);</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;      } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        <span class="comment">// For input instance ports, the dataflow is into the referenced module.</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        <span class="comment">// Input RefType port implies, generating an upward scoped XMR.</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        <span class="comment">// No need to add the instance context, since downward reference must be</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        <span class="comment">// through single instantiated modules.</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        <span class="keywordflow">if</span> (multiplyInstantiated)</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;          <span class="keywordflow">return</span> refMod.emitOpError(</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                     <span class="stringliteral">&quot;multiply instantiated module with input RefType port &#39;&quot;</span>)</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                 &lt;&lt; refMod.getPortName(portNum) &lt;&lt; <span class="stringliteral">&quot;&#39;&quot;</span>;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        dataFlowClasses-&gt;unionSets(</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;            dataFlowClasses-&gt;getOrInsertLeaderValue(refModuleArg),</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;            dataFlowClasses-&gt;getOrInsertLeaderValue(instanceResult));</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;      }</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    }</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;  }</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160; </div>
<div class="line"><a name="l00497"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a87b48d37568a88ed82c6daf7f6715cda">  497</a></span>&#160;  LogicalResult <a class="code" href="classLowerXMRPass.html#a87b48d37568a88ed82c6daf7f6715cda">handlePublicModuleRefPorts</a>(FModuleOp module) {</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="keyword">auto</span> <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a> = ImplicitLocOpBuilder::atBlockBegin(</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        module.getLoc(), getOperation().getBodyBlock());</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160; </div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    SmallString&lt;128&gt; circuitRefPrefix;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> portIndex = 0, numPorts = module.getNumPorts();</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;         portIndex != numPorts; ++portIndex) {</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;      <span class="keyword">auto</span> refType = module.getPortType(portIndex).dyn_cast&lt;RefType&gt;();</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;      <span class="keywordflow">if</span> (!refType || isZeroWidth(refType.getType()) ||</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;          module.getPortDirection(portIndex) != <a class="code" href="namespacecirct_1_1firrtl.html#a10bd365aff28fd9856f68f241520e738a7c147cda9e49590f6abe83d118b7353b">Direction::Out</a>)</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;      <span class="keyword">auto</span> portValue =</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;          module.getArgument(portIndex).cast&lt;mlir::TypedValue&lt;RefType&gt;&gt;();</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160; </div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;      mlir::FlatSymbolRefAttr ref;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;      SmallString&lt;128&gt; stringLeaf;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;      <span class="keywordflow">if</span> (failed(resolveReferencePath(portValue, <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>, ref, stringLeaf)))</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;        <span class="keywordflow">return</span> failure();</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160; </div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;      SmallString&lt;128&gt; formatString;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;      <span class="keywordflow">if</span> (ref)</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        formatString += <span class="stringliteral">&quot;{{0}}&quot;</span>;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;      formatString += stringLeaf;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160; </div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;      <span class="comment">// Insert a macro with the format:</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;      <span class="comment">// ref_&lt;circuit-name&gt;_&lt;module-name&gt;_&lt;ref-name&gt; &lt;path&gt;</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;      <span class="keywordflow">if</span> (circuitRefPrefix.empty())</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        getRefABIPrefix(module, circuitRefPrefix);</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;      <span class="keyword">auto</span> macroName =</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;          getRefABIMacroForPort(module, portIndex, circuitRefPrefix);</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;      <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.create&lt;sv::MacroDeclOp&gt;(macroName, ArrayAttr(), StringAttr());</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160; </div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;      <span class="keyword">auto</span> macroDefOp = <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.create&lt;sv::MacroDefOp&gt;(</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;          <a class="code" href="namespacecirct_1_1calyx_1_1direction.html#aa581977b67c4a52e186e2d320010f50f">FlatSymbolRefAttr::get</a>(macroName),</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;          <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.getStringAttr(formatString),</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;          <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.getArrayAttr(ref ? ref : ArrayRef&lt;Attribute&gt;{}));</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160; </div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;      <span class="comment">// The macro will be exported to a file with the format:</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;      <span class="comment">// ref_&lt;circuit-name&gt;_&lt;module-name&gt;.sv</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;      macroDefOp-&gt;setAttr(<span class="stringliteral">&quot;output_file&quot;</span>,</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                          hw::OutputFileAttr::getFromFilename(</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                              &amp;getContext(), circuitRefPrefix + <span class="stringliteral">&quot;.sv&quot;</span>));</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    }</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160; </div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <span class="keywordflow">return</span> success();</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  }</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="comment">  /// Get the cached namespace for a module.</span></div>
<div class="line"><a name="l00545"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a49a6f885d1634d62e279f1028bcb7bbc">  545</a></span>&#160;<span class="comment"></span>  <a class="code" href="structcirct_1_1firrtl_1_1ModuleNamespace.html">ModuleNamespace</a> &amp;<a class="code" href="classLowerXMRPass.html#a49a6f885d1634d62e279f1028bcb7bbc">getModuleNamespace</a>(FModuleLike module) {</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    <span class="keyword">auto</span> it = moduleNamespaces.find(module);</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="keywordflow">if</span> (it != moduleNamespaces.end())</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;      <span class="keywordflow">return</span> it-&gt;second;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="keywordflow">return</span> moduleNamespaces.insert({module, <a class="code" href="structcirct_1_1firrtl_1_1ModuleNamespace.html">ModuleNamespace</a>(module)})</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        .first-&gt;second;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;  }</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160; </div>
<div class="line"><a name="l00553"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a3473a0f42a715a7a2cd5fd7df5059133">  553</a></span>&#160;  InnerRefAttr <a class="code" href="classLowerXMRPass.html#a3473a0f42a715a7a2cd5fd7df5059133">getInnerRefTo</a>(Value val) {</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">auto</span> arg = val.dyn_cast&lt;BlockArgument&gt;())</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;      <a class="code" href="namespacecirct_1_1firrtl.html#a5eefad9da2ff3aecab7b11cf35ac59d4">return ::getInnerRefTo</a>(</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;          cast&lt;FModuleLike&gt;(arg.getParentBlock()-&gt;getParentOp()),</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;          arg.getArgNumber(), <span class="stringliteral">&quot;xmr_sym&quot;</span>,</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;          [&amp;](FModuleLike mod) -&gt; <a class="code" href="structcirct_1_1firrtl_1_1ModuleNamespace.html">ModuleNamespace</a> &amp; {</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            return getModuleNamespace(mod);</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;          });</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="namespacecirct_1_1firrtl.html#a5eefad9da2ff3aecab7b11cf35ac59d4">getInnerRefTo</a>(val.getDefiningOp());</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  }</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160; </div>
<div class="line"><a name="l00565"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#abf16c0568d4374889099ed5857a068ff">  565</a></span>&#160;  InnerRefAttr <a class="code" href="classLowerXMRPass.html#abf16c0568d4374889099ed5857a068ff">getInnerRefTo</a>(Operation *op) {</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    <a class="code" href="namespacecirct_1_1firrtl.html#a5eefad9da2ff3aecab7b11cf35ac59d4">return ::getInnerRefTo</a>(op, <span class="stringliteral">&quot;xmr_sym&quot;</span>,</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                           [&amp;](FModuleOp mod) -&gt; <a class="code" href="structcirct_1_1firrtl_1_1ModuleNamespace.html">ModuleNamespace</a> &amp; {</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                             <span class="keywordflow">return</span> getModuleNamespace(mod);</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                           });</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  }</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160; </div>
<div class="line"><a name="l00572"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a659597f8ab48d07dba06f298a8b2beda">  572</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classLowerXMRPass.html#a659597f8ab48d07dba06f298a8b2beda">markForRemoval</a>(Operation *op) { opsToRemove.push_back(op); }</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160; </div>
<div class="line"><a name="l00574"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a7b4e180bd6616bbb6e4f7c68af4e0e3c">  574</a></span>&#160;  std::optional&lt;size_t&gt; <a class="code" href="classLowerXMRPass.html#a7b4e180bd6616bbb6e4f7c68af4e0e3c">getRemoteRefSend</a>(Value val) {</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="keyword">auto</span> iter = dataflowAt.find(dataFlowClasses-&gt;getOrInsertLeaderValue(val));</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    <span class="keywordflow">if</span> (iter != dataflowAt.end())</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;      <span class="keywordflow">return</span> iter-&gt;getSecond();</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    <span class="comment">// The referenced module must have already been analyzed, error out if the</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    <span class="comment">// dataflow at the child module is not resolved.</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <span class="keywordflow">if</span> (BlockArgument arg = val.dyn_cast&lt;BlockArgument&gt;())</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;      arg.getOwner()-&gt;getParentOp()-&gt;emitError(</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;          <span class="stringliteral">&quot;reference dataflow cannot be traced back to the remote read op &quot;</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;          <span class="stringliteral">&quot;for module port &#39;&quot;</span>)</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;          &lt;&lt; dyn_cast&lt;FModuleOp&gt;(arg.getOwner()-&gt;getParentOp())</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                 .getPortName(arg.getArgNumber())</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;          &lt;&lt; <span class="stringliteral">&quot;&#39;&quot;</span>;</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;      val.getDefiningOp()-&gt;emitOpError(</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;          <span class="stringliteral">&quot;reference dataflow cannot be traced back to the remote read op&quot;</span>);</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    signalPassFailure();</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <span class="keywordflow">return</span> std::nullopt;</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;  }</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160; </div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;  <span class="keywordtype">size_t</span></div>
<div class="line"><a name="l00595"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a8ff802b3511c63fcc54ad78570c76a4e">  595</a></span>&#160;  <a class="code" href="classLowerXMRPass.html#a8ff802b3511c63fcc54ad78570c76a4e">addReachingSendsEntry</a>(Value atRefVal, Attribute newRef,</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                        std::optional&lt;size_t&gt; continueFrom = std::nullopt) {</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    <span class="keyword">auto</span> leader = dataFlowClasses-&gt;getOrInsertLeaderValue(atRefVal);</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <span class="keyword">auto</span> indx = refSendPathList.size();</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    dataflowAt[leader] = indx;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="keywordflow">if</span> (continueFrom.has_value()) {</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;      <span class="keywordflow">if</span> (!refSendPathList[*continueFrom].first) {</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        <span class="comment">// This handles the case when the InnerRef is set to null at the</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        <span class="comment">// following path, that implies the path ends at this node, so copy the</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <span class="comment">// xmrPathSuffix and end the path here.</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        <span class="keyword">auto</span> xmrIter = xmrPathSuffix.find(*continueFrom);</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        <span class="keywordflow">if</span> (xmrIter != xmrPathSuffix.end()) {</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;          SmallString&lt;128&gt; xmrSuffix = xmrIter-&gt;getSecond();</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;          <span class="comment">// The following assignment to the DenseMap can potentially reallocate</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;          <span class="comment">// the map, that might invalidate the `xmrIter`. So, copy the result</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;          <span class="comment">// to a temp, and then insert it back to the Map.</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;          xmrPathSuffix[indx] = xmrSuffix;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        }</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        continueFrom = std::nullopt;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;      }</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    }</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    refSendPathList.push_back(std::make_pair(newRef, continueFrom));</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <span class="keywordflow">return</span> indx;</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;  }</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160; </div>
<div class="line"><a name="l00620"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a7e26d97aacfeb20f66d5a13b04a42573">  620</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classLowerXMRPass.html#a7e26d97aacfeb20f66d5a13b04a42573">garbageCollect</a>() {</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="comment">// Now erase all the Ops and ports of RefType.</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <span class="comment">// This needs to be done as the last step to ensure uses are erased before</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <span class="comment">// the def is erased.</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    <span class="keywordflow">for</span> (Operation *op : llvm::reverse(opsToRemove))</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;      op-&gt;erase();</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> iter : refPortsToRemoveMap)</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">auto</span> mod = dyn_cast&lt;FModuleOp&gt;(iter.getFirst()))</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        mod.erasePorts(iter.getSecond());</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> mod = dyn_cast&lt;FExtModuleOp&gt;(iter.getFirst()))</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        mod.erasePorts(iter.getSecond());</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> inst = dyn_cast&lt;InstanceOp&gt;(iter.getFirst())) {</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        ImplicitLocOpBuilder b(inst.getLoc(), inst);</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        inst.erasePorts(b, iter.getSecond());</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        inst.erase();</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> mem = dyn_cast&lt;MemOp&gt;(iter.getFirst())) {</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="comment">// Remove all debug ports of the memory.</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        ImplicitLocOpBuilder <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>(mem.getLoc(), mem);</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        SmallVector&lt;Attribute, 4&gt; resultNames;</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        SmallVector&lt;Type, 4&gt; resultTypes;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        SmallVector&lt;Attribute, 4&gt; portAnnotations;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        SmallVector&lt;Value, 4&gt; oldResults;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;res : llvm::enumerate(mem.getResults())) {</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;          <span class="keywordflow">if</span> (isa&lt;RefType&gt;(mem.getResult(res.index()).getType()))</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;          resultNames.push_back(mem.getPortName(res.index()));</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;          resultTypes.push_back(res.value().getType());</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;          portAnnotations.push_back(mem.getPortAnnotation(res.index()));</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;          oldResults.push_back(res.value());</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        }</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        <span class="keyword">auto</span> newMem = <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.create&lt;MemOp&gt;(</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;            resultTypes, mem.getReadLatency(), mem.getWriteLatency(),</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;            mem.getDepth(), RUWAttr::Undefined,</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.getArrayAttr(resultNames), mem.getNameAttr(),</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            mem.getNameKind(), mem.getAnnotations(),</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;            <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.getArrayAttr(portAnnotations), mem.getInnerSymAttr(),</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            mem.getInitAttr(), mem.getPrefixAttr());</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;res : llvm::enumerate(oldResults))</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;          res.value().replaceAllUsesWith(newMem.getResult(res.index()));</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        mem.erase();</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;      }</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    opsToRemove.clear();</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    refPortsToRemoveMap.clear();</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    dataflowAt.clear();</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    refSendPathList.clear();</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;  }</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160; </div>
<div class="line"><a name="l00667"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#ae96815e6db594433411037e6841de1f9">  667</a></span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="classLowerXMRPass.html#ae96815e6db594433411037e6841de1f9">isZeroWidth</a>(<a class="code" href="classcirct_1_1firrtl_1_1FIRRTLBaseType.html">FIRRTLBaseType</a> t) { <span class="keywordflow">return</span> t.<a class="code" href="classcirct_1_1firrtl_1_1FIRRTLBaseType.html#a3450449794ceac913fdb5b252bc63d27">getBitWidthOrSentinel</a>() == 0; }</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="comment">  /// Return a HierPathOp for the provided pathArray.  This will either return</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="comment">  /// an existing HierPathOp or it will create and return a new one.</span></div>
<div class="line"><a name="l00671"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a3a796b74069d213976dbf93738cb62e9">  671</a></span>&#160;<span class="comment"></span>  hw::HierPathOp <a class="code" href="classLowerXMRPass.html#a3a796b74069d213976dbf93738cb62e9">getOrCreatePath</a>(ArrayAttr pathArray,</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                                 ImplicitLocOpBuilder &amp;<a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>) {</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    assert(pathArray &amp;&amp; !pathArray.empty());</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    <span class="comment">// Return an existing HierPathOp if one exists with the same path.</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keyword">auto</span> pathIter = pathCache.find(pathArray);</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    <span class="keywordflow">if</span> (pathIter != pathCache.end())</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;      <span class="keywordflow">return</span> pathIter-&gt;second;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160; </div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <span class="comment">// Reset the insertion point after this function returns.</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    OpBuilder::InsertionGuard guard(<a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>);</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160; </div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    <span class="comment">// Set the insertion point to either the known location where the pass</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <span class="comment">// inserts HierPathOps or to the start of the circuit.</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    <span class="keywordflow">if</span> (pathInsertPoint.isSet())</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;      <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.restoreInsertionPoint(pathInsertPoint);</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;      <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.setInsertionPointToStart(getOperation().getBodyBlock());</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160; </div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    <span class="comment">// Create the new HierPathOp and insert it into the pathCache.</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    hw::HierPathOp path =</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        pathCache</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;            .insert({pathArray,</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;                     <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.create&lt;hw::HierPathOp&gt;(</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;                         circuitNamespace-&gt;newName(<span class="stringliteral">&quot;xmrPath&quot;</span>), pathArray)})</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            .first-&gt;second;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    path.setVisibility(SymbolTable::Visibility::Private);</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160; </div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    <span class="comment">// Save the insertion point so other unique HierPathOps will be created</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    <span class="comment">// after this one.</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    pathInsertPoint = <a class="code" href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a>.saveInsertionPoint();</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160; </div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="comment">// Return the new path.</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    <span class="keywordflow">return</span> path;</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;  }</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160; </div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="keyword">private</span>:<span class="comment"></span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="comment">  /// Cached module namespaces.</span></div>
<div class="line"><a name="l00708"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a2034557b7fb41d010d7a6e831cce4310">  708</a></span>&#160;<span class="comment"></span>  DenseMap&lt;Operation *, ModuleNamespace&gt; <a class="code" href="classLowerXMRPass.html#a2034557b7fb41d010d7a6e831cce4310">moduleNamespaces</a>;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160; </div>
<div class="line"><a name="l00710"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#ab603ea3c65c3db4dfbb2a90e5b0adec5">  710</a></span>&#160;  DenseSet&lt;Operation *&gt; <a class="code" href="classLowerXMRPass.html#ab603ea3c65c3db4dfbb2a90e5b0adec5">visitedModules</a>;<span class="comment"></span></div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="comment">  /// Map of a reference value to an entry into refSendPathList. Each entry in</span></div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="comment">  /// refSendPathList represents the path to RefSend.</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="comment">  /// The path is required since there can be multiple paths to the RefSend and</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;<span class="comment">  /// we need to identify a unique path.</span></div>
<div class="line"><a name="l00715"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a412e6aba1be82f83ea51465e4ec213d7">  715</a></span>&#160;<span class="comment"></span>  DenseMap&lt;Value, size_t&gt; <a class="code" href="classLowerXMRPass.html#a412e6aba1be82f83ea51465e4ec213d7">dataflowAt</a>;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="comment">  /// refSendPathList is used to construct a path to the RefSendOp. Each entry</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="comment">  /// is a node, with an InnerRefAttr and a pointer to the next node in the</span></div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="comment">  /// path. The InnerRefAttr can be to an InstanceOp or to the XMR defining</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="comment">  /// op. All the nodes representing an InstanceOp must have a valid</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="comment">  /// nextNodeOnPath. Only the node representing the final XMR defining op has</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="comment">  /// no nextNodeOnPath, which denotes a leaf node on the path.</span></div>
<div class="line"><a name="l00723"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a20c3b940dd7c2505a966f23c31664ff5">  723</a></span>&#160;<span class="comment"></span>  <span class="keyword">using</span> <a class="code" href="classLowerXMRPass.html#a20c3b940dd7c2505a966f23c31664ff5">nextNodeOnPath</a> = std::optional&lt;size_t&gt;;</div>
<div class="line"><a name="l00724"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#ad6a1ce92074f2bdb9cc4a29c186f2dea">  724</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="classLowerXMRPass.html#ad6a1ce92074f2bdb9cc4a29c186f2dea">node</a> = std::pair&lt;Attribute, nextNodeOnPath&gt;;</div>
<div class="line"><a name="l00725"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a6425331fa0a37082a82af4684f63642e">  725</a></span>&#160;  SmallVector&lt;node&gt; <a class="code" href="classLowerXMRPass.html#a6425331fa0a37082a82af4684f63642e">refSendPathList</a>;</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="comment">  /// llvm::EquivalenceClasses wants comparable elements. This comparator uses</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="comment">  /// uses pointer comparison on the Impl.</span></div>
<div class="line"><a name="l00729"></a><span class="lineno"><a class="line" href="structLowerXMRPass_1_1ValueComparator.html">  729</a></span>&#160;<span class="comment"></span>  <span class="keyword">struct </span><a class="code" href="structLowerXMRPass_1_1ValueComparator.html">ValueComparator</a> {</div>
<div class="line"><a name="l00730"></a><span class="lineno"><a class="line" href="structLowerXMRPass_1_1ValueComparator.html#a9603f1f4d9969cf497fafe64584ed773">  730</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="structLowerXMRPass_1_1ValueComparator.html#a9603f1f4d9969cf497fafe64584ed773">operator()</a>(<span class="keyword">const</span> Value &amp;lhs, <span class="keyword">const</span> Value &amp;rhs)<span class="keyword"> const </span>{</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;      <span class="keywordflow">return</span> lhs.getImpl() &lt; rhs.getImpl();</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    }</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;  };</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160; </div>
<div class="line"><a name="l00735"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a6393431c6d5ea1929d54931acc9368ba">  735</a></span>&#160;  llvm::EquivalenceClasses&lt;Value, ValueComparator&gt; *<a class="code" href="classLowerXMRPass.html#a6393431c6d5ea1929d54931acc9368ba">dataFlowClasses</a>;</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;  <span class="comment">// Instance and module ref ports that needs to be removed.</span></div>
<div class="line"><a name="l00737"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a9b6612201ecc4241ac816a435e1b2aa2">  737</a></span>&#160;  DenseMap&lt;Operation *, llvm::BitVector&gt; <a class="code" href="classLowerXMRPass.html#a9b6612201ecc4241ac816a435e1b2aa2">refPortsToRemoveMap</a>;</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;<span class="comment">  /// RefResolve, RefSend, and Connects involving them that will be removed.</span></div>
<div class="line"><a name="l00740"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#af9a9f02740b84a012067743d4e789f47">  740</a></span>&#160;<span class="comment"></span>  SmallVector&lt;Operation *&gt; <a class="code" href="classLowerXMRPass.html#af9a9f02740b84a012067743d4e789f47">opsToRemove</a>;</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="comment">  /// Record the internal path to an external module or a memory.</span></div>
<div class="line"><a name="l00743"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a1d1e3a9fbe015a58448ab25f6037d442">  743</a></span>&#160;<span class="comment"></span>  DenseMap&lt;size_t, SmallString&lt;128&gt;&gt; <a class="code" href="classLowerXMRPass.html#a1d1e3a9fbe015a58448ab25f6037d442">xmrPathSuffix</a>;</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160; </div>
<div class="line"><a name="l00745"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#adb37ad522ce1f508d3fa0c46b29a3234">  745</a></span>&#160;  <a class="code" href="structcirct_1_1firrtl_1_1CircuitNamespace.html">CircuitNamespace</a> *<a class="code" href="classLowerXMRPass.html#adb37ad522ce1f508d3fa0c46b29a3234">circuitNamespace</a>;</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<span class="comment">  /// A cache of already created HierPathOps.  This is used to avoid repeatedly</span></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="comment">  /// creating the same HierPathOp.</span></div>
<div class="line"><a name="l00749"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#a96812180f23f20aaa4843b6b6a290101">  749</a></span>&#160;<span class="comment"></span>  DenseMap&lt;Attribute, hw::HierPathOp&gt; <a class="code" href="classLowerXMRPass.html#a96812180f23f20aaa4843b6b6a290101">pathCache</a>;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="comment">  /// The insertion point where the pass inserts HierPathOps.</span></div>
<div class="line"><a name="l00752"></a><span class="lineno"><a class="line" href="classLowerXMRPass.html#ac11ab18c66d18b20e16e47e95b4ba506">  752</a></span>&#160;<span class="comment"></span>  OpBuilder::InsertPoint pathInsertPoint = {};</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;};</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160; </div>
<div class="line"><a name="l00755"></a><span class="lineno"><a class="line" href="namespacecirct_1_1firrtl.html#aab817928c6fdb0faf4bc8719c55e3c6e">  755</a></span>&#160;std::unique_ptr&lt;mlir::Pass&gt; <a class="code" href="namespacecirct_1_1firrtl.html#aab817928c6fdb0faf4bc8719c55e3c6e">circt::firrtl::createLowerXMRPass</a>() {</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  <span class="keywordflow">return</span> std::make_unique&lt;LowerXMRPass&gt;();</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;}</div>
<div class="ttc" id="aDialect_2FIRRTL_2Passes_8h_html"><div class="ttname"><a href="Dialect_2FIRRTL_2Passes_8h.html">Passes.h</a></div></div>
<div class="ttc" id="aFIRRTLInstanceGraph_8h_html"><div class="ttname"><a href="FIRRTLInstanceGraph_8h.html">FIRRTLInstanceGraph.h</a></div></div>
<div class="ttc" id="aFIRRTLUtils_8h_html"><div class="ttname"><a href="FIRRTLUtils_8h.html">FIRRTLUtils.h</a></div></div>
<div class="ttc" id="aHandshakeExecutableOps_8cpp_html_ae2fc2adce0f8f62ecaa80aea76c72cdb"><div class="ttname"><a href="HandshakeExecutableOps_8cpp.html#ae2fc2adce0f8f62ecaa80aea76c72cdb">toVector</a></div><div class="ttdeci">static std::vector&lt; mlir::Value &gt; toVector(mlir::ValueRange range)</div><div class="ttdef"><b>Definition:</b> <a href="HandshakeExecutableOps_8cpp_source.html#l00025">HandshakeExecutableOps.cpp:25</a></div></div>
<div class="ttc" id="aPassHelpers_8cpp_html_aeadefc9e3d2de1953d16800a15493a47"><div class="ttname"><a href="PassHelpers_8cpp.html#aeadefc9e3d2de1953d16800a15493a47">builder</a></div><div class="ttdeci">Builder builder</div><div class="ttdef"><b>Definition:</b> <a href="PassHelpers_8cpp_source.html#l00251">PassHelpers.cpp:251</a></div></div>
<div class="ttc" id="aSVOps_8h_html"><div class="ttname"><a href="SVOps_8h.html">SVOps.h</a></div></div>
<div class="ttc" id="aSchema_8cpp_html_aaead200a3c5da00983c0940a507aac19"><div class="ttname"><a href="Schema_8cpp.html#aaead200a3c5da00983c0940a507aac19">size</a></div><div class="ttdeci">static int64_t size(hw::ArrayType mType, capnp::schema::Field::Reader cField)</div><div class="ttdoc">Returns the expected size of an array (capnp list) in 64-bit words.</div><div class="ttdef"><b>Definition:</b> <a href="Schema_8cpp_source.html#l00192">Schema.cpp:192</a></div></div>
<div class="ttc" id="aSystemC_2Transforms_2PassDetails_8h_html"><div class="ttname"><a href="SystemC_2Transforms_2PassDetails_8h.html">PassDetails.h</a></div></div>
<div class="ttc" id="aclassLowerXMRBase_html"><div class="ttname"><a href="classLowerXMRBase.html">LowerXMRBase</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html"><div class="ttname"><a href="classLowerXMRPass.html">LowerXMRPass</a></div><div class="ttdoc">The LowerXMRPass will replace every RefResolveOp with an XMR encoded within a verbatim expr op.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00050">LowerXMR.cpp:50</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a1d1e3a9fbe015a58448ab25f6037d442"><div class="ttname"><a href="classLowerXMRPass.html#a1d1e3a9fbe015a58448ab25f6037d442">LowerXMRPass::xmrPathSuffix</a></div><div class="ttdeci">DenseMap&lt; size_t, SmallString&lt; 128 &gt; &gt; xmrPathSuffix</div><div class="ttdoc">Record the internal path to an external module or a memory.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00743">LowerXMR.cpp:743</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a2034557b7fb41d010d7a6e831cce4310"><div class="ttname"><a href="classLowerXMRPass.html#a2034557b7fb41d010d7a6e831cce4310">LowerXMRPass::moduleNamespaces</a></div><div class="ttdeci">DenseMap&lt; Operation *, ModuleNamespace &gt; moduleNamespaces</div><div class="ttdoc">Cached module namespaces.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00708">LowerXMR.cpp:708</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a20c3b940dd7c2505a966f23c31664ff5"><div class="ttname"><a href="classLowerXMRPass.html#a20c3b940dd7c2505a966f23c31664ff5">LowerXMRPass::nextNodeOnPath</a></div><div class="ttdeci">std::optional&lt; size_t &gt; nextNodeOnPath</div><div class="ttdoc">refSendPathList is used to construct a path to the RefSendOp.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00723">LowerXMR.cpp:723</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a2ce876a5713aa5672f44e510aaac216d"><div class="ttname"><a href="classLowerXMRPass.html#a2ce876a5713aa5672f44e510aaac216d">LowerXMRPass::resolveReference</a></div><div class="ttdeci">LogicalResult resolveReference(mlir::TypedValue&lt; RefType &gt; refVal, Type desiredType, Location loc, Operation *insertBefore, Value &amp;out)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00339">LowerXMR.cpp:339</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a3473a0f42a715a7a2cd5fd7df5059133"><div class="ttname"><a href="classLowerXMRPass.html#a3473a0f42a715a7a2cd5fd7df5059133">LowerXMRPass::getInnerRefTo</a></div><div class="ttdeci">InnerRefAttr getInnerRefTo(Value val)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00553">LowerXMR.cpp:553</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a3a796b74069d213976dbf93738cb62e9"><div class="ttname"><a href="classLowerXMRPass.html#a3a796b74069d213976dbf93738cb62e9">LowerXMRPass::getOrCreatePath</a></div><div class="ttdeci">hw::HierPathOp getOrCreatePath(ArrayAttr pathArray, ImplicitLocOpBuilder &amp;builder)</div><div class="ttdoc">Return a HierPathOp for the provided pathArray.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00671">LowerXMR.cpp:671</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a3f1a72db88eafeb5a7adf34234f7a9c0"><div class="ttname"><a href="classLowerXMRPass.html#a3f1a72db88eafeb5a7adf34234f7a9c0">LowerXMRPass::resolveReferencePath</a></div><div class="ttdeci">LogicalResult resolveReferencePath(mlir::TypedValue&lt; RefType &gt; refVal, ImplicitLocOpBuilder builder, mlir::FlatSymbolRefAttr &amp;ref, SmallString&lt; 128 &gt; &amp;stringLeaf)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00301">LowerXMR.cpp:301</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a412e6aba1be82f83ea51465e4ec213d7"><div class="ttname"><a href="classLowerXMRPass.html#a412e6aba1be82f83ea51465e4ec213d7">LowerXMRPass::dataflowAt</a></div><div class="ttdeci">DenseMap&lt; Value, size_t &gt; dataflowAt</div><div class="ttdoc">Map of a reference value to an entry into refSendPathList.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00715">LowerXMR.cpp:715</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a46b26eec1b23beda7287018682f09cd6"><div class="ttname"><a href="classLowerXMRPass.html#a46b26eec1b23beda7287018682f09cd6">LowerXMRPass::setPortToRemove</a></div><div class="ttdeci">void setPortToRemove(Operation *op, size_t index, size_t numPorts)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00406">LowerXMR.cpp:406</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a49a6f885d1634d62e279f1028bcb7bbc"><div class="ttname"><a href="classLowerXMRPass.html#a49a6f885d1634d62e279f1028bcb7bbc">LowerXMRPass::getModuleNamespace</a></div><div class="ttdeci">ModuleNamespace &amp; getModuleNamespace(FModuleLike module)</div><div class="ttdoc">Get the cached namespace for a module.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00545">LowerXMR.cpp:545</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a6393431c6d5ea1929d54931acc9368ba"><div class="ttname"><a href="classLowerXMRPass.html#a6393431c6d5ea1929d54931acc9368ba">LowerXMRPass::dataFlowClasses</a></div><div class="ttdeci">llvm::EquivalenceClasses&lt; Value, ValueComparator &gt; * dataFlowClasses</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00735">LowerXMR.cpp:735</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a6425331fa0a37082a82af4684f63642e"><div class="ttname"><a href="classLowerXMRPass.html#a6425331fa0a37082a82af4684f63642e">LowerXMRPass::refSendPathList</a></div><div class="ttdeci">SmallVector&lt; node &gt; refSendPathList</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00725">LowerXMR.cpp:725</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a659597f8ab48d07dba06f298a8b2beda"><div class="ttname"><a href="classLowerXMRPass.html#a659597f8ab48d07dba06f298a8b2beda">LowerXMRPass::markForRemoval</a></div><div class="ttdeci">void markForRemoval(Operation *op)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00572">LowerXMR.cpp:572</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a7b4e180bd6616bbb6e4f7c68af4e0e3c"><div class="ttname"><a href="classLowerXMRPass.html#a7b4e180bd6616bbb6e4f7c68af4e0e3c">LowerXMRPass::getRemoteRefSend</a></div><div class="ttdeci">std::optional&lt; size_t &gt; getRemoteRefSend(Value val)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00574">LowerXMR.cpp:574</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a7e26d97aacfeb20f66d5a13b04a42573"><div class="ttname"><a href="classLowerXMRPass.html#a7e26d97aacfeb20f66d5a13b04a42573">LowerXMRPass::garbageCollect</a></div><div class="ttdeci">void garbageCollect()</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00620">LowerXMR.cpp:620</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a87b48d37568a88ed82c6daf7f6715cda"><div class="ttname"><a href="classLowerXMRPass.html#a87b48d37568a88ed82c6daf7f6715cda">LowerXMRPass::handlePublicModuleRefPorts</a></div><div class="ttdeci">LogicalResult handlePublicModuleRefPorts(FModuleOp module)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00497">LowerXMR.cpp:497</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a8f0f600fa050b35b5cda5e7c6f29f47a"><div class="ttname"><a href="classLowerXMRPass.html#a8f0f600fa050b35b5cda5e7c6f29f47a">LowerXMRPass::getRefABIPrefix</a></div><div class="ttdeci">void getRefABIPrefix(FModuleLike mod, SmallVectorImpl&lt; char &gt; &amp;prefix)</div><div class="ttdoc">Generate the ABI ref_&lt;circuit&gt;_&lt;module&gt; prefix string into prefix.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00286">LowerXMR.cpp:286</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a8ff802b3511c63fcc54ad78570c76a4e"><div class="ttname"><a href="classLowerXMRPass.html#a8ff802b3511c63fcc54ad78570c76a4e">LowerXMRPass::addReachingSendsEntry</a></div><div class="ttdeci">size_t addReachingSendsEntry(Value atRefVal, Attribute newRef, std::optional&lt; size_t &gt; continueFrom=std::nullopt)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00595">LowerXMR.cpp:595</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a92a25b8006dfb4da40983f6c1972e634"><div class="ttname"><a href="classLowerXMRPass.html#a92a25b8006dfb4da40983f6c1972e634">LowerXMRPass::runOnOperation</a></div><div class="ttdeci">void runOnOperation() override</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00052">LowerXMR.cpp:52</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a96812180f23f20aaa4843b6b6a290101"><div class="ttname"><a href="classLowerXMRPass.html#a96812180f23f20aaa4843b6b6a290101">LowerXMRPass::pathCache</a></div><div class="ttdeci">DenseMap&lt; Attribute, hw::HierPathOp &gt; pathCache</div><div class="ttdoc">A cache of already created HierPathOps.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00749">LowerXMR.cpp:749</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a9aa1a2b971c6c4d874412f79130b5537"><div class="ttname"><a href="classLowerXMRPass.html#a9aa1a2b971c6c4d874412f79130b5537">LowerXMRPass::handleRefResolve</a></div><div class="ttdeci">LogicalResult handleRefResolve(RefResolveOp resolve)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00386">LowerXMR.cpp:386</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_a9b6612201ecc4241ac816a435e1b2aa2"><div class="ttname"><a href="classLowerXMRPass.html#a9b6612201ecc4241ac816a435e1b2aa2">LowerXMRPass::refPortsToRemoveMap</a></div><div class="ttdeci">DenseMap&lt; Operation *, llvm::BitVector &gt; refPortsToRemoveMap</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00737">LowerXMR.cpp:737</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_aa95bf4b65745e19ee9526b0579aa6255"><div class="ttname"><a href="classLowerXMRPass.html#aa95bf4b65745e19ee9526b0579aa6255">LowerXMRPass::handleInstanceOp</a></div><div class="ttdeci">LogicalResult handleInstanceOp(InstanceOp inst, InstanceGraph &amp;instanceGraph)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00413">LowerXMR.cpp:413</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_aaf949e3bee6facb7d9546cae89ca8947"><div class="ttname"><a href="classLowerXMRPass.html#aaf949e3bee6facb7d9546cae89ca8947">LowerXMRPass::handleForceReleaseOp</a></div><div class="ttdeci">LogicalResult handleForceReleaseOp(Operation *op)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00369">LowerXMR.cpp:369</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_ab603ea3c65c3db4dfbb2a90e5b0adec5"><div class="ttname"><a href="classLowerXMRPass.html#ab603ea3c65c3db4dfbb2a90e5b0adec5">LowerXMRPass::visitedModules</a></div><div class="ttdeci">DenseSet&lt; Operation * &gt; visitedModules</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00710">LowerXMR.cpp:710</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_abf16c0568d4374889099ed5857a068ff"><div class="ttname"><a href="classLowerXMRPass.html#abf16c0568d4374889099ed5857a068ff">LowerXMRPass::getInnerRefTo</a></div><div class="ttdeci">InnerRefAttr getInnerRefTo(Operation *op)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00565">LowerXMR.cpp:565</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_ad3948d553efd6e879f7a117b64027452"><div class="ttname"><a href="classLowerXMRPass.html#ad3948d553efd6e879f7a117b64027452">LowerXMRPass::getRefABIMacroForPort</a></div><div class="ttdeci">StringAttr getRefABIMacroForPort(FModuleLike mod, size_t portIndex, const Twine &amp;prefix, bool backTick=false)</div><div class="ttdoc">Get full macro name as StringAttr for the specified ref port.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00295">LowerXMR.cpp:295</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_ad6a1ce92074f2bdb9cc4a29c186f2dea"><div class="ttname"><a href="classLowerXMRPass.html#ad6a1ce92074f2bdb9cc4a29c186f2dea">LowerXMRPass::node</a></div><div class="ttdeci">std::pair&lt; Attribute, nextNodeOnPath &gt; node</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00724">LowerXMR.cpp:724</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_adb37ad522ce1f508d3fa0c46b29a3234"><div class="ttname"><a href="classLowerXMRPass.html#adb37ad522ce1f508d3fa0c46b29a3234">LowerXMRPass::circuitNamespace</a></div><div class="ttdeci">CircuitNamespace * circuitNamespace</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00745">LowerXMR.cpp:745</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_ae96815e6db594433411037e6841de1f9"><div class="ttname"><a href="classLowerXMRPass.html#ae96815e6db594433411037e6841de1f9">LowerXMRPass::isZeroWidth</a></div><div class="ttdeci">bool isZeroWidth(FIRRTLBaseType t)</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00667">LowerXMR.cpp:667</a></div></div>
<div class="ttc" id="aclassLowerXMRPass_html_af9a9f02740b84a012067743d4e789f47"><div class="ttname"><a href="classLowerXMRPass.html#af9a9f02740b84a012067743d4e789f47">LowerXMRPass::opsToRemove</a></div><div class="ttdeci">SmallVector&lt; Operation * &gt; opsToRemove</div><div class="ttdoc">RefResolve, RefSend, and Connects involving them that will be removed.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00740">LowerXMR.cpp:740</a></div></div>
<div class="ttc" id="aclasscirct_1_1firrtl_1_1FIRRTLBaseType_html"><div class="ttname"><a href="classcirct_1_1firrtl_1_1FIRRTLBaseType.html">circt::firrtl::FIRRTLBaseType</a></div><div class="ttdef"><b>Definition:</b> <a href="FIRRTLTypes_8h_source.html#l00117">FIRRTLTypes.h:119</a></div></div>
<div class="ttc" id="aclasscirct_1_1firrtl_1_1FIRRTLBaseType_html_a3450449794ceac913fdb5b252bc63d27"><div class="ttname"><a href="classcirct_1_1firrtl_1_1FIRRTLBaseType.html#a3450449794ceac913fdb5b252bc63d27">circt::firrtl::FIRRTLBaseType::getBitWidthOrSentinel</a></div><div class="ttdeci">int32_t getBitWidthOrSentinel()</div><div class="ttdoc">If this is an IntType, AnalogType, or sugar type for a single bit (Clock, Reset, etc) then return the...</div><div class="ttdef"><b>Definition:</b> <a href="FIRRTLTypes_8cpp_source.html#l00635">FIRRTLTypes.cpp:635</a></div></div>
<div class="ttc" id="aclasscirct_1_1firrtl_1_1InstanceGraph_html"><div class="ttname"><a href="classcirct_1_1firrtl_1_1InstanceGraph.html">circt::firrtl::InstanceGraph</a></div><div class="ttdoc">This graph tracks modules and where they are instantiated.</div><div class="ttdef"><b>Definition:</b> <a href="FIRRTLInstanceGraph_8h_source.html#l00035">FIRRTLInstanceGraph.h:35</a></div></div>
<div class="ttc" id="aclasscirct_1_1hw_1_1InstanceGraphBase_html_a18f485f0d18e1b9ad410f9063128ed27"><div class="ttname"><a href="classcirct_1_1hw_1_1InstanceGraphBase.html#a18f485f0d18e1b9ad410f9063128ed27">circt::hw::InstanceGraphBase::getReferencedModule</a></div><div class="ttdeci">HWModuleLike getReferencedModule(HWInstanceLike op)</div><div class="ttdoc">Look up the referenced module from an InstanceOp.</div><div class="ttdef"><b>Definition:</b> <a href="InstanceGraphBase_8cpp_source.html#l00097">InstanceGraphBase.cpp:97</a></div></div>
<div class="ttc" id="anamespacePython_1_1support_html_a0cb288c4cfff043062b7cd9001842aef"><div class="ttname"><a href="namespacePython_1_1support.html#a0cb288c4cfff043062b7cd9001842aef">Python.support.connect</a></div><div class="ttdeci">def connect(destination, source)</div><div class="ttdef"><b>Definition:</b> <a href="support_8py_source.html#l00037">support.py:37</a></div></div>
<div class="ttc" id="anamespacecirct_1_1calyx_1_1direction_html_aa581977b67c4a52e186e2d320010f50f"><div class="ttname"><a href="namespacecirct_1_1calyx_1_1direction.html#aa581977b67c4a52e186e2d320010f50f">circt::calyx::direction::get</a></div><div class="ttdeci">Direction get(bool isOutput)</div><div class="ttdoc">Returns an output direction if isOutput is true, otherwise returns an input direction.</div><div class="ttdef"><b>Definition:</b> <a href="CalyxOps_8cpp_source.html#l00042">CalyxOps.cpp:42</a></div></div>
<div class="ttc" id="anamespacecirct_1_1firrtl_html_a10bd365aff28fd9856f68f241520e738a7c147cda9e49590f6abe83d118b7353b"><div class="ttname"><a href="namespacecirct_1_1firrtl.html#a10bd365aff28fd9856f68f241520e738a7c147cda9e49590f6abe83d118b7353b">circt::firrtl::Direction::Out</a></div><div class="ttdeci">@ Out</div></div>
<div class="ttc" id="anamespacecirct_1_1firrtl_html_a5eefad9da2ff3aecab7b11cf35ac59d4"><div class="ttname"><a href="namespacecirct_1_1firrtl.html#a5eefad9da2ff3aecab7b11cf35ac59d4">circt::firrtl::getInnerRefTo</a></div><div class="ttdeci">hw::InnerRefAttr getInnerRefTo(Operation *op, StringRef nameHint, std::function&lt; ModuleNamespace &amp;(FModuleOp)&gt; getNamespace)</div><div class="ttdoc">Obtain an inner reference to an operation, possibly adding an inner_sym to that operation.</div><div class="ttdef"><b>Definition:</b> <a href="FIRRTLUtils_8cpp_source.html#l00649">FIRRTLUtils.cpp:649</a></div></div>
<div class="ttc" id="anamespacecirct_1_1firrtl_html_aab817928c6fdb0faf4bc8719c55e3c6e"><div class="ttname"><a href="namespacecirct_1_1firrtl.html#aab817928c6fdb0faf4bc8719c55e3c6e">circt::firrtl::createLowerXMRPass</a></div><div class="ttdeci">std::unique_ptr&lt; mlir::Pass &gt; createLowerXMRPass()</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00755">LowerXMR.cpp:755</a></div></div>
<div class="ttc" id="anamespacecirct_1_1firrtl_html_ac239807a86d466ca630d2c61d8ab76f4"><div class="ttname"><a href="namespacecirct_1_1firrtl.html#ac239807a86d466ca630d2c61d8ab76f4">circt::firrtl::lowerType</a></div><div class="ttdeci">Type lowerType(Type type)</div><div class="ttdoc">Given a type, return the corresponding lowered type for the HW dialect.</div><div class="ttdef"><b>Definition:</b> <a href="FIRRTLUtils_8cpp_source.html#l00814">FIRRTLUtils.cpp:814</a></div></div>
<div class="ttc" id="anamespacecirct_1_1firrtl_html_afb23ce325dff5394c22df2487dffd4f1"><div class="ttname"><a href="namespacecirct_1_1firrtl.html#afb23ce325dff5394c22df2487dffd4f1">circt::firrtl::getBitWidth</a></div><div class="ttdeci">std::optional&lt; int64_t &gt; getBitWidth(FIRRTLBaseType type, bool ignoreFlip=false)</div><div class="ttdef"><b>Definition:</b> <a href="FIRRTLTypes_8cpp_source.html#l02112">FIRRTLTypes.cpp:2112</a></div></div>
<div class="ttc" id="anamespacecirct_1_1firrtl_html_afe91edad7a64c9ec34e055ca4ce54635"><div class="ttname"><a href="namespacecirct_1_1firrtl.html#afe91edad7a64c9ec34e055ca4ce54635">circt::firrtl::getIntZerosAttr</a></div><div class="ttdeci">IntegerAttr getIntZerosAttr(Type type)</div><div class="ttdoc">Utility for generating a constant zero attribute.</div><div class="ttdef"><b>Definition:</b> <a href="FIRRTLUtils_8cpp_source.html#l00143">FIRRTLUtils.cpp:143</a></div></div>
<div class="ttc" id="anamespacecirct_html"><div class="ttname"><a href="namespacecirct.html">circt</a></div><div class="ttdoc">This file defines an intermediate representation for circuits acting as an abstraction for constraint...</div><div class="ttdef"><b>Definition:</b> <a href="DependenceAnalysis_8h_source.html#l00030">DependenceAnalysis.h:30</a></div></div>
<div class="ttc" id="anamespacelec_html_af6450bd100960fe39a58efd9733ddea4"><div class="ttname"><a href="namespacelec.html#af6450bd100960fe39a58efd9733ddea4">lec::dbgs</a></div><div class="ttdeci">mlir::raw_indented_ostream &amp; dbgs()</div><div class="ttdef"><b>Definition:</b> <a href="Utility_8h_source.html#l00028">Utility.h:28</a></div></div>
<div class="ttc" id="astructLowerXMRPass_1_1ValueComparator_html"><div class="ttname"><a href="structLowerXMRPass_1_1ValueComparator.html">LowerXMRPass::ValueComparator</a></div><div class="ttdoc">llvm::EquivalenceClasses wants comparable elements.</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00729">LowerXMR.cpp:729</a></div></div>
<div class="ttc" id="astructLowerXMRPass_1_1ValueComparator_html_a9603f1f4d9969cf497fafe64584ed773"><div class="ttname"><a href="structLowerXMRPass_1_1ValueComparator.html#a9603f1f4d9969cf497fafe64584ed773">LowerXMRPass::ValueComparator::operator()</a></div><div class="ttdeci">bool operator()(const Value &amp;lhs, const Value &amp;rhs) const</div><div class="ttdef"><b>Definition:</b> <a href="LowerXMR_8cpp_source.html#l00730">LowerXMR.cpp:730</a></div></div>
<div class="ttc" id="astructcirct_1_1firrtl_1_1CircuitNamespace_html"><div class="ttname"><a href="structcirct_1_1firrtl_1_1CircuitNamespace.html">circt::firrtl::CircuitNamespace</a></div><div class="ttdoc">The namespace of a CircuitOp, generally inhabited by modules.</div><div class="ttdef"><b>Definition:</b> <a href="Dialect_2FIRRTL_2Namespace_8h_source.html#l00024">Namespace.h:24</a></div></div>
<div class="ttc" id="astructcirct_1_1firrtl_1_1ModuleNamespace_html"><div class="ttname"><a href="structcirct_1_1firrtl_1_1ModuleNamespace.html">circt::firrtl::ModuleNamespace</a></div><div class="ttdoc">The namespace of a FModuleLike operation, generally inhabited by its ports and declarations.</div><div class="ttdef"><b>Definition:</b> <a href="Dialect_2FIRRTL_2Namespace_8h_source.html#l00041">Namespace.h:41</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue May 30 2023 00:29:41 for CIRCT by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
